<!DOCTYPE html>
<html lang="es">
<%- include('../partials/head', { title: 'Viajes - Semanal' }) %>
<body>
  <%- include('../partials/nav') %>

  <div class="container">
    <h1>Viajes - Resúmenes semanales</h1>

    <div class="card">
      <h2>Seleccionar mes, semana y cliente (opcional)</h2>

      <form method="GET" action="/viajes/semanal" class="row">
        <input type="hidden" name="year" value="<%= year %>"/>

        <div style="min-width:220px;">
          <label>Mes</label>
          <select name="month" onchange="this.form.submit()">
            <% months.forEach(m => { %>
              <option value="<%= m.value %>" <%= Number(month)===Number(m.value) ? 'selected' : '' %>><%= m.label %></option>
            <% }) %>
          </select>
        </div>

        <div style="min-width:340px;">
          <label>Semana (Lunes a Domingo)</label>
          <select name="weekStart" onchange="this.form.submit()">
            <option value="">-- Elegir semana --</option>
            <% weeks.forEach(w => { %>
              <option value="<%= w.weekStart %>" <%= weekStart===w.weekStart ? 'selected' : '' %>><%= w.label %></option>
            <% }) %>
          </select>
        </div>

        <div style="min-width:260px;">
          <label>Cliente (opcional)</label>
          <select name="clientId" onchange="this.form.submit()">
            <option value="">-- Todos --</option>
            <% clients.forEach(c => { %>
              <option value="<%= c.id %>" <%= String(clientId)===String(c.id) ? 'selected' : '' %>><%= c.full_name %></option>
            <% }) %>
          </select>
        </div>
      </form>
    </div>

    <% if (dashboard) { %>
      <div class="card">
        <h2>Resumen semanal</h2>
        <p><b>Semana:</b> <%= weekStart %> al <%= weekEnd %></p>
        <% if (clientId) { %>
          <p><b>Cliente:</b> <%= clients.find(x=>String(x.id)===String(clientId))?.full_name || 'Seleccionado' %></p>
        <% } %>
        <p><b>Ventas:</b> <%= dashboard.sales_count %></p>
        <p><b>Cobrado:</b> Efectivo $<%= dashboard.saldo_cobrado_efectivo.toFixed(2) %> | Transferencia $<%= dashboard.saldo_cobrado_transferencia.toFixed(2) %></p>
        <p><b>A cobrar (fiado/vales):</b> $<%= dashboard.saldo_a_cobrar.toFixed(2) %></p>
        <p><b>Ventas con deuda:</b> <%= dashboard.ventas_con_deuda %></p>
      </div>

      <div class="card">
        <h2>Días de la semana</h2>
        <div class="grid">
          <% days.forEach(d => { %>
            <a class="card card--link"
               href="/viajes/resumen/dia?date=<%= d.date %>&clientId=<%= clientId || '' %>&weekStart=<%= weekStart %>&month=<%= month %>&year=<%= year %>">
               <%= d.label %>
            </a>
          <% }) %>
        </div>
      </div>

      <div class="card">
        <h2>Ventas de la semana</h2>

        <% if (!salesList.length) { %>
          <p>No hay ventas en esta semana.</p>
        <% } %>

        <% salesList.forEach(s => { %>
          <div class="sale">
            <div class="sale__top">
              <div>
                <b><%= s.dayISO %> <%= s.time %></b>
                <span> | <%= s.client_name %></span>
              </div>
              <span class="badge"><%= s.payment_method %></span>
            </div>

            <div class="sale__mid">
              <span>Cant: <%= Number(s.qty || 1) %></span>
              <span>Unit: $<%= Number(s.product_price || 0).toFixed(2) %></span>
              <span>Flete: $<%= Number(s.freight_price || 0).toFixed(2) %></span>
              <span>Total: $<%= Number(s.final_price || 0).toFixed(2) %></span>
              <span>Deuda: $<%= Number(s.debt || 0).toFixed(2) %></span>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>

    <div class="row">
      <a class="btn" href="/viajes/vender">Venta</a>
      <a class="btn btn--ghost" href="/viajes">Volver</a>
    </div>
  </div>

  <%- include('../partials/footer') %>
</body>
</html>
